<!doctype html>
<html>
  <head>
    <meta charset="utf-8">

    <!-- Always force latest IE rendering engine or request Chrome Frame -->
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

    <!-- Use title if it's in the page YAML frontmatter -->
    <title>Code & Theology</title>

    <link href="/stylesheets/normalize.css" rel="stylesheet" type="text/css" /><link href="/stylesheets/all.css" rel="stylesheet" type="text/css" /><link href="/stylesheets/style.css" rel="stylesheet" type="text/css" /><link href="/stylesheets/syntax.css" rel="stylesheet" type="text/css" />
    <script src="/javascripts/jquery.js" type="text/javascript"></script><script src="/javascripts/ga.js" type="text/javascript"></script><script src="/javascripts/mobile.js" type="text/javascript"></script>
  </head>

  <body lang="en-US" class="home blog custom-background x2015 x2015_05 x2015_05_21 x2015_05_21_strong-like-bull-a-lesson-in-recursion">
    <section class="top-bar cf">
      <button class="mobile-nav-button">
        <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="100px" height="100px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve"><rect x="0.208" y="10.167" fill="#FFFFFF" width="99.792" height="19.958"></rect><rect x="0.208" y="40.104" fill="#FFFFFF" width="99.792" height="19.958"></rect><rect x="0.208" y="70.041" fill="#FFFFFF" width="99.792" height="19.959"></rect></svg>
        <svg class="close-icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="100px" height="100px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve"><path fill="#FFFFFF" d="M63.973 49.999l34.76-34.762c1.335-1.333 1.335-3.494 0-4.826l-9.144-9.146 c-1.333-1.332-3.493-1.332-4.827 0L50 36.028L15.237 1.265c-1.332-1.332-3.493-1.332-4.826 0l-9.146 9.146 c-1.333 1.332-1.333 3.493 0 4.826l34.763 34.762L1.267 84.762c-1.334 1.334-1.334 3.493 0 4.826l9.145 9.146 c1.333 1.334 3.495 1.334 4.826 0L50 63.973l34.761 34.761c1.334 1.334 3.493 1.334 4.826 0l9.146-9.146 c1.333-1.333 1.333-3.492 0-4.826L63.973 49.999z"></path></svg>
        <span class="mobile-nav-label">Navigation</span>
      </button>
    </section>
    <ul id="mobile-menu" class="menu mobile-menu mobile-nav">
      <li class="menu-item close-item close">
        <button class="mobile-nav-close-button">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="100px" height="100px" viewBox="0 0 100 100" enable-background="new 0 0 100 100" xml:space="preserve"><path fill="#FFFFFF" d="M63.973 49.999l34.76-34.762c1.335-1.333 1.335-3.494 0-4.826l-9.144-9.146 c-1.333-1.332-3.493-1.332-4.827 0L50 36.028L15.237 1.265c-1.332-1.332-3.493-1.332-4.826 0l-9.146 9.146 c-1.333 1.332-1.333 3.493 0 4.826l34.763 34.762L1.267 84.762c-1.334 1.334-1.334 3.493 0 4.826l9.145 9.146 c1.333 1.334 3.495 1.334 4.826 0L50 63.973l34.761 34.761c1.334 1.334 3.493 1.334 4.826 0l9.146-9.146 c1.333-1.333 1.333-3.492 0-4.826L63.973 49.999z"></path></svg>
          <span class="mobile-nav-close-button-label">Close</span>
        </button>
      </li>
      <li class="menu-item menu-label primary_nav_label">Main Menu</li>
      <li class="menu-item "><a href="/">Home</a></li>
      <li class="menu-item "><a href="/category/code.html">Code</a></li>
      <li class="menu-item "><a href="/category/theology.html">Theology</a></li>
      <li class="menu-item "><a href="/category/life.html">Life</a></li>
    </ul>

  <!-- Header	-->
  <header id="header" class="cf">
    <div class="in">
      <section class="logo-box logo-box-no-header-cta logo-box-full-width">
        <h1 id="title" class="site-title site-title-no-logo no-logo">
          <a href="/" title="Code &amp; Theology (&amp; Life)">
            Code &amp; Theology (&amp; Life)			</a>
          </h1>
          <h2 id="slogan" class="slogan ">
          </h2>
        </section>
      </div>

      <nav class="primary-nav-container">
        <div class="in">
          <ul id="primary-nav" class="primary-nav menu">
            <li class="menu-item menu-item-type-custom menu-item-object-custom
                       ">
              <a href="/">Home</a>
            </li>
            <li class="menu-item menu-item-type-custom menu-item-object-custom
                       ">
              <a href="/about-me.html">About</a>
            </li>
              <li class="menu-item menu-item-type-taxonomy menu-item-object-category
                         ">
                <a href="/category/code.html">code</a>
              </li>
              <li class="menu-item menu-item-type-taxonomy menu-item-object-category
                         ">
                <a href="/category/theology.html">theology</a>
              </li>
              <li class="menu-item menu-item-type-taxonomy menu-item-object-category
                         ">
                <a href="/category/life.html">life</a>
              </li>
          </ul>
        </div>
      </nav>
    </header>

    <div class="in">
      <h3>&tl;dr;</h3>

<p>I’ve created a new gem called <a href="https://github.com/hunterae/strong_like_bull">StrongLikeBull</a> that suggests what parameters to permit in your strong parameters configuration based on what request parameters a controller action receives.</p>

<p>After repeating the same task multiple times in a row, I start looking for shortcuts. The problem I was facing was how to configure <a href="https://github.com/rails/strong_parameters">Strong Parameters</a> in our applications as part of a company-wide effort to upgrade to Ruby on Rails 4.2. There were a lot of controllers in the application I was configuring, and this quickly became a very tedious task. For each controller, I was configuring debugger lines in the controller action, examining the request params, and then manually figuring out how what the strong parameters format would look like. Then, given the strong parameter’s required field and permitted params, I could run the strong parameters expression against the request params and make sure I was getting the same output as input.</p>

<p>So after repeating this several times, I began to wonder if there was a better way. A Google search revealed nothing (perhaps I couldn’t figure out what exactly to search for). I also came across a more complex example: some of our api controllers get hit from external services, and we don’t necessarily know what params they are passing. Certainly some auditing was in order, but this also represented another strong case for the use of strong params. Finding no viable solution out there, I began to explore implementing my own. </p>

<p>Because request params can be passed in the form of hashes, arrays, hashes of arrays, and arrays of hashes, and they can be infinitely nested, this seemed like the perfect case for <a href="http://en.wikipedia.org/wiki/Recursion_(computer_science)">recursion</a>. Recursion is usually a fun case study, so I figured I’d break down how I got Rails to automatically make suggestions of permitted params to configure for strong parameters.</p>

<h3>Overview: Divide &amp; Conquer</h3>

<p>Given a request to a Rails application, such as to a sessions controller to login to a application, the request parameters will likely be very simple. They might look somethings like this:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="p">{</span><span class="ss">user: </span><span class="p">{</span><span class="ss">email: </span><span class="s2">"test@test.com"</span><span class="p">,</span> <span class="ss">password: </span><span class="s2">"password"</span><span class="p">,</span> <span class="ss">remember_me: </span><span class="s2">"1"</span> <span class="p">}}</span>
</pre></td></tr></tbody></table>
</div>

<p>With a basic understanding of Strong Parameters, it’s rather trivial to eye these parameters and manually convert them to Strong Parameters format:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">permit</span> <span class="p">[</span><span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:remember_me</span><span class="p">]</span>
</pre></td></tr></tbody></table>
</div>

<p>What happens though, when your example is thoroughly more complex than this? What happens when you’ve got nested attributes, and they have nested attributes, and the nested attributes might have different fields being specified. How do you dissect a request that looks like this:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19</pre></td><td class="code"><pre><span class="p">{</span><span class="s2">"product"</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s2">"name"</span><span class="o">=&gt;</span><span class="s2">"fake product"</span><span class="p">,</span> <span class="s2">"summary"</span><span class="o">=&gt;</span><span class="s2">"create your fake treats"</span><span class="p">,</span>
                <span class="s2">"random_field_1"</span><span class="o">=&gt;</span><span class="s2">""</span><span class="p">,</span> <span class="s2">"random_field_2"</span><span class="o">=&gt;</span><span class="s2">"234asfdsfd"</span><span class="p">,</span> <span class="s2">"random_field_3"</span><span class="o">=&gt;</span><span class="s2">"23"</span><span class="p">,</span>
                <span class="s2">"random_field_4"</span><span class="o">=&gt;</span><span class="s2">"1"</span><span class="p">,</span> <span class="s2">"random_field_5"</span><span class="o">=&gt;</span><span class="s2">"0.0"</span><span class="p">,</span>
                <span class="s2">"random_field_6"</span><span class="o">=&gt;</span><span class="s2">"23"</span><span class="p">,</span> <span class="s2">"random_field_7"</span><span class="o">=&gt;</span><span class="s2">"7.5"</span><span class="p">,</span>
                <span class="s2">"random_field_8"</span><span class="o">=&gt;</span><span class="s2">"32323"</span><span class="p">,</span> <span class="s2">"random_field_9"</span><span class="o">=&gt;</span><span class="s2">"2015-04-22"</span><span class="p">,</span>
                <span class="s2">"random_field_10"</span><span class="o">=&gt;</span><span class="s2">""</span><span class="p">,</span> <span class="s2">"random_field_11"</span><span class="o">=&gt;</span><span class="s2">""</span><span class="p">,</span>
                <span class="s2">"random_field_12"</span><span class="o">=&gt;</span><span class="s2">"2"</span><span class="p">,</span> <span class="s2">"random_field_13"</span><span class="o">=&gt;</span><span class="s2">"0"</span><span class="p">,</span>
                <span class="s2">"random_field_14"</span><span class="o">=&gt;</span><span class="p">[</span><span class="s2">""</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"3"</span><span class="p">],</span>
                <span class="s2">"random_field_15"</span><span class="o">=&gt;</span><span class="s2">"0"</span><span class="p">,</span> <span class="s2">"random_field_16"</span><span class="o">=&gt;</span><span class="p">[</span><span class="s2">""</span><span class="p">,</span> <span class="s2">"fashion"</span><span class="p">,</span> <span class="s2">"home goods"</span><span class="p">],</span>
                <span class="s2">"random_field_17"</span><span class="o">=&gt;</span><span class="s2">"506"</span><span class="p">,</span> <span class="s2">"random_field_18"</span><span class="o">=&gt;</span><span class="s2">"23"</span><span class="p">,</span>
                <span class="s2">"random_field_19"</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">"random_field_20"</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">"random_field_21"</span><span class="o">=&gt;</span><span class="s2">""</span><span class="p">,</span> <span class="s2">"random_field_22"</span><span class="o">=&gt;</span><span class="s2">"2"</span><span class="p">}},</span>
                <span class="s2">"random_field_23"</span><span class="o">=&gt;</span><span class="s2">"1"</span><span class="p">,</span> <span class="s2">"random_field_24"</span><span class="o">=&gt;</span><span class="s2">"1"</span><span class="p">,</span> <span class="s2">"random_field_25"</span><span class="o">=&gt;</span><span class="s2">"1"</span><span class="p">,</span>
                <span class="s2">"random_field_26"</span><span class="o">=&gt;</span><span class="s2">"2fsasd"</span><span class="p">,</span> <span class="s2">"random_field_27"</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">"random_field_28"</span><span class="o">=&gt;</span><span class="s2">"sdfafsd"</span><span class="p">},</span>
                <span class="s2">"random_field_29"</span><span class="o">=&gt;</span><span class="s2">"2013-02-25 06:00:00"</span><span class="p">,</span> <span class="s2">"random_field_30"</span><span class="o">=&gt;</span><span class="s2">"2013-03-04 12:59:59"</span><span class="p">,</span>
                <span class="s2">"random_field_31"</span><span class="o">=&gt;</span><span class="s2">"1"</span><span class="p">,</span> <span class="s2">"random_field_32"</span><span class="o">=&gt;</span><span class="s2">"fadsfds"</span><span class="p">,</span>
                <span class="s2">"random_field_33"</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">"random_field_34"</span><span class="o">=&gt;</span><span class="s2">"Tim Teseterson"</span><span class="p">,</span> <span class="s2">"random_field_35"</span><span class="o">=&gt;</span><span class="s2">""</span><span class="p">,</span> <span class="s2">"random_field_36"</span><span class="o">=&gt;</span><span class="s2">""</span><span class="p">,</span> <span class="s2">"random_field_37"</span><span class="o">=&gt;</span><span class="s2">"1234"</span><span class="p">},</span>
                <span class="s2">"random_field_38"</span><span class="o">=&gt;</span><span class="s2">"1234"</span><span class="p">,</span> <span class="s2">"random_field_39"</span><span class="o">=&gt;</span><span class="s2">"1"</span><span class="p">,</span> <span class="s2">"random_field_40"</span><span class="o">=&gt;</span><span class="s2">"1"</span><span class="p">,</span> <span class="s2">"random_field_41"</span><span class="o">=&gt;</span><span class="s2">"0"</span><span class="p">,</span>
                <span class="s2">"random_field_42"</span><span class="o">=&gt;</span><span class="s2">""</span><span class="p">,</span> <span class="s2">"random_field_43"</span><span class="o">=&gt;</span><span class="s2">""</span><span class="p">,</span>
                <span class="s2">"random_field_44"</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">"random_field_45"</span><span class="o">=&gt;</span><span class="s2">""</span><span class="p">,</span> <span class="s2">"random_field_46"</span><span class="o">=&gt;</span><span class="s2">""</span><span class="p">,</span> <span class="s2">"random_field_47"</span><span class="o">=&gt;</span><span class="s2">""</span><span class="p">}}</span>
</pre></td></tr></tbody></table>
</div>

<p>Into this:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:product</span><span class="p">).</span><span class="nf">permit</span> <span class="p">[</span>
<span class="ss">:name</span><span class="p">,</span> <span class="ss">:summary</span><span class="p">,</span> <span class="ss">:random_field_1</span><span class="p">,</span> <span class="ss">:random_field_2</span><span class="p">,</span> <span class="ss">:random_field_3</span><span class="p">,</span> <span class="ss">:random_field_4</span><span class="p">,</span> <span class="ss">:random_field_5</span><span class="p">,</span>
<span class="ss">:random_field_6</span><span class="p">,</span> <span class="ss">:random_field_7</span><span class="p">,</span> <span class="ss">:random_field_8</span><span class="p">,</span> <span class="ss">:random_field_9</span><span class="p">,</span> <span class="ss">:random_field_10</span><span class="p">,</span> <span class="ss">:random_field_11</span><span class="p">,</span>
<span class="ss">:random_field_12</span><span class="p">,</span> <span class="ss">:random_field_13</span><span class="p">,</span> <span class="p">{</span><span class="ss">:random_field_14</span> <span class="o">=&gt;</span> <span class="p">[]},</span> <span class="ss">:random_field_15</span><span class="p">,</span> <span class="p">{</span><span class="ss">:random_field_16</span> <span class="o">=&gt;</span> <span class="p">[]},</span> <span class="ss">:random_field_17</span><span class="p">,</span> <span class="ss">:random_field_18</span><span class="p">,</span>
<span class="p">{</span><span class="ss">:random_field_19</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:random_field_20</span><span class="p">,</span> <span class="ss">:random_field_21</span><span class="p">,</span> <span class="ss">:random_field_22</span><span class="p">]},</span> <span class="ss">:random_field_23</span><span class="p">,</span> <span class="ss">:random_field_24</span><span class="p">,</span> <span class="ss">:random_field_25</span><span class="p">,</span>
<span class="ss">:random_field_26</span><span class="p">,</span>
<span class="p">{</span><span class="ss">:random_field_27</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:random_field_28</span><span class="p">]</span> <span class="p">},</span> <span class="ss">:random_field_29</span><span class="p">,</span> <span class="ss">:random_field_30</span><span class="p">,</span> <span class="ss">:random_field_31</span><span class="p">,</span> <span class="ss">:random_field_32</span><span class="p">,</span>
<span class="p">{</span><span class="ss">:random_field_33</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:random_field_34</span><span class="p">,</span> <span class="ss">:random_field_35</span><span class="p">,</span> <span class="ss">:random_field_36</span><span class="p">,</span> <span class="ss">:random_field_37</span><span class="p">]},</span>
<span class="ss">:random_field_38</span><span class="p">,</span> <span class="ss">:random_field_39</span><span class="p">,</span> <span class="ss">:random_field_40</span><span class="p">,</span> <span class="ss">:random_field_41</span><span class="p">,</span> <span class="ss">:random_field_42</span><span class="p">,</span>
<span class="ss">:random_field_43</span><span class="p">,</span> <span class="p">{</span><span class="ss">:random_field_44</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:random_field_45</span><span class="p">,</span> <span class="ss">:random_field_46</span><span class="p">,</span> <span class="ss">:random_field_47</span><span class="p">]}]</span>
</pre></td></tr></tbody></table>
</div>

<p>Perhaps you’ve had to deal with this kind of example, or maybe a more difficult case. If so, you know the pain and tedium of meticulously converting over request params.</p>

<p>Instead, let’s try and solve this problem using a <a href="http://www.radford.edu/~nokie/classes/360/divcon.html">divide and conquer</a> strategy. Let’s pull out chunks of the params hash and work on them individually and then combine the results.</p>

<h3>Step 1: Identify the Base Cases</h3>

<p>Before we get into nested hashes, or arrays of hashes, or hashes with arrays as values, let’s consider two of the most basic ways params might get passed to your controller: hashes and arrays.</p>

<h3>Hashes:</h3>

<p>A login request might receive the following request params:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="p">{</span> <span class="ss">user: </span><span class="p">{</span><span class="ss">email: </span><span class="s2">"test@test.com"</span><span class="p">,</span> <span class="ss">password: </span><span class="s2">"password"</span> <span class="p">}}</span>
</pre></td></tr></tbody></table>
</div>

<p>The strong parameters configuration for this request is super simple:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">).</span><span class="nf">permit</span><span class="p">([</span><span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">])</span>
</pre></td></tr></tbody></table>
</div>

<p>Notice what happened there? The object <code>{email: “test@test.com”, password: “password”}</code> changed from a hash to an array, with the elements of the array matching the keys of the hash: <code>[:email, :password]</code>. We’ll use this principle as one of the basic cases to handle.</p>

<p>If, then, we are examining a hash, each key of the hash that maps to a non-hash, non-array, will be represented as a symbol in the array. So <code>{a1: 1, a2: “2”, a3: 2.3}</code> becomes <code>[:a1, :a2, :a3]</code>.</p>

<p>The code for such a block might look something like this:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">recursive_suggested_strong_parameters_format</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">object</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span>
    <span class="n">permitted_params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">object</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span> <span class="o">||</span> <span class="n">value</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Array</span><span class="p">)</span>
        <span class="c1"># do something recursive; we'll fill this out below</span>
      <span class="k">else</span>
        <span class="n">permitted_params</span> <span class="o">&lt;&lt;</span> <span class="ss">:"</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="ss">"</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">permitted_params</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">recursive_suggested_strong_parameters_format</span><span class="p">(</span><span class="ss">a1: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">a2: </span><span class="s2">"2"</span><span class="p">,</span> <span class="ss">a3: </span><span class="mi">2</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># =&gt; [:a1, :a2, :a3]</span>
</pre></td></tr></tbody></table>
</div>

<h3>Arrays:</h3>

<p>A update request to a Post class might receive the following request params: <code>{ id: 123, post: { tags: [“code”, “theology”] }}</code></p>

<p>The strong parameters configuration for this request is likewise simple:
<code>params.require(:post).permit({tags: []})</code></p>

<p>The piece I want to focus on is that the array of Strings got represented in strong parameter’s world as an empty array: []</p>

<p>This means that if we encounter an array where the elements of the array are non-hashes, non-arrays, we can simply treat this in strong parameters as a []</p>

<p>The code for such a block might look something like this:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">recursive_suggested_strong_parameters_format</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">object</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span>
    <span class="n">permitted_params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">object</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span> <span class="o">||</span> <span class="n">value</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Array</span><span class="p">)</span>
        <span class="c1"># do something recursive; we'll fill this out below</span>
      <span class="k">else</span>
        <span class="n">permitted_params</span> <span class="o">&lt;&lt;</span> <span class="ss">:"</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="ss">"</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">permitted_params</span>
  <span class="k">elsif</span> <span class="n">object</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Array</span><span class="p">)</span>
    <span class="c1"># it is sufficient to look at the first element of the array to determine if this is an array of hashes of just a array of scalars</span>
    <span class="k">if</span> <span class="n">object</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span>
      <span class="c1"># do something recursive; we'll fill this out below</span>
    <span class="k">else</span>
      <span class="p">[]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">recursive_suggested_strong_parameters_format</span> <span class="p">[</span><span class="s2">"code"</span><span class="p">,</span> <span class="s2">"theology"</span><span class="p">]</span> <span class="c1"># =&gt; []</span>
</pre></td></tr></tbody></table>
</div>

<p>Step 2: Identify the Recursion Cases</p>

<p>Now that we have the boundary cases considered, let’s examine how we would handle the non-basic cases: hashes of arrays, arrays of hashes, and hashes of hashes. This is where we will start to see the need for recursion.</p>

<h3>Hashes of Arrays</h3>

<p>We actually already saw a recursion example above when we looked at the array example of updating a Post with the request params:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="p">{</span> <span class="ss">id: </span><span class="mi">123</span><span class="p">,</span> <span class="ss">post: </span><span class="p">{</span> <span class="ss">tags: </span><span class="p">[</span><span class="s2">"code"</span><span class="p">,</span> <span class="s2">"theology"</span><span class="p">]</span> <span class="p">}}</span>
</pre></td></tr></tbody></table>
</div>

<p>In the boundary cases, when we encountered a hash, we simply added the hash key to an array of permitted params. Now, however, we’re dealing with a hash element whose value element is an array. We already saw above how to deal with simple arrays (by returning an empty array []). So we know if we call our recursive<em>suggested</em>strong<em>parameters</em>format method with [“code”, “theology”], the function will return []. What we need then is for that return value to be set as the value of a new hash. Our expected format would then be: {tags: []} So how do we get there? Let’s update our function so it recursively calls itself:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">recursive_suggested_strong_parameters_format</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">object</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span>
    <span class="n">permitted_params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">object</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span> <span class="o">||</span> <span class="n">value</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Array</span><span class="p">)</span>
        <span class="n">permitted_params</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="ss">:"</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="ss">"</span> <span class="o">=&gt;</span> <span class="n">recursive_suggested_strong_parameters_format</span><span class="p">(</span><span class="n">value</span><span class="p">)}</span>
      <span class="k">else</span>
        <span class="n">permitted_params</span> <span class="o">&lt;&lt;</span> <span class="ss">:"</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="ss">"</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">permitted_params</span>
  <span class="k">elsif</span> <span class="n">object</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Array</span><span class="p">)</span>
    <span class="c1"># it is sufficient to look at the first element of the array to determine if this is an array of hashes of just a array of scalars</span>
    <span class="k">if</span> <span class="n">object</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span>
      <span class="c1"># do something recursive; we'll fill this out below</span>
    <span class="k">else</span>
      <span class="p">[]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">recursive_suggested_strong_parameters_format</span><span class="p">(</span><span class="ss">tags: </span><span class="p">[</span><span class="s2">"code"</span><span class="p">,</span> <span class="s2">"theology"</span><span class="p">])</span> <span class="c1"># =&gt; [{tags: []}]</span>
</pre></td></tr></tbody></table>
</div>

<h3>Arrays of Hashes</h3>

<p>Next let’s consider arrays of Hashes, such as the following request, this time, setting the products for a particular object</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="p">{</span> <span class="ss">products: </span><span class="p">[{</span><span class="ss">id: </span><span class="mi">50</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"Product 1"</span><span class="p">},</span> <span class="p">{</span><span class="ss">id: </span><span class="mi">51</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"Product 2"</span><span class="p">}]}</span>
</pre></td></tr></tbody></table>
</div>

<p>Here, we’ve got an array of products, which are each represented by a hash. Our code above is not yet covering this case, but the expected output would be:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="p">[{</span><span class="ss">products: </span><span class="p">[</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">]}]</span>
</pre></td></tr></tbody></table>
</div>

<p>So how do we get there then? By combining cases we’ve already handled. We already know how to handle a hash with scalar values. We just saw how to handle a hash with an array as the value. So let’s sub in our missing piece in the code:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">recursive_suggested_strong_parameters_format</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">object</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span>
    <span class="n">permitted_params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">object</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span> <span class="o">||</span> <span class="n">value</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Array</span><span class="p">)</span>
        <span class="n">permitted_params</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="ss">:"</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="ss">"</span> <span class="o">=&gt;</span> <span class="n">recursive_suggested_strong_parameters_format</span><span class="p">(</span><span class="n">value</span><span class="p">)}</span>
      <span class="k">else</span>
        <span class="n">permitted_params</span> <span class="o">&lt;&lt;</span> <span class="ss">:"</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="ss">"</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">permitted_params</span>
  <span class="k">elsif</span> <span class="n">object</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Array</span><span class="p">)</span>
    <span class="c1"># it is sufficient to look at the first element of the array to determine if this is an array of hashes of just a array of scalars</span>
    <span class="k">if</span> <span class="n">object</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span>
      <span class="n">recursive_suggested_strong_parameters_format</span><span class="p">(</span><span class="n">object</span><span class="p">.</span><span class="nf">first</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="p">[]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">recursive_suggested_strong_parameters_format</span><span class="p">(</span><span class="ss">products: </span><span class="p">[{</span><span class="ss">id: </span><span class="mi">50</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"Product 1"</span><span class="p">},</span> <span class="p">{</span><span class="ss">id: </span><span class="mi">51</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"Product 2"</span><span class="p">}])</span> <span class="c1"># =&gt; [{:products=&gt;[:id, :name]}]</span>
</pre></td></tr></tbody></table>
</div>

<h3>Hash of Hashes</h3>

<p>By handling previous cases, our code is already setup to handle a hash of hashes of hashes of etc. Let’s try it out:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="n">recursive_suggested_strong_parameters_format</span><span class="p">(</span><span class="ss">product: </span><span class="p">{</span><span class="ss">product_details: </span><span class="p">{</span><span class="ss">merchant: </span><span class="p">{</span><span class="ss">market: </span><span class="p">{</span><span class="ss">name: </span><span class="s2">"US"</span><span class="p">}}}})</span>
<span class="c1"># =&gt; [{:product =&gt; [{:product_details =&gt; [{:merchant =&gt; [{:market =&gt; [:name]}]}]}]}]</span>
</pre></td></tr></tbody></table>
</div>

<h3>Step 3: Handle the Edge Cases</h3>

<p>I wish I could say we were done there, and the fact of the matter is, this will likely handle most cases out there. But what about Rail’s <a href="http://api.rubyonrails.org/classes/ActiveRecord/NestedAttributes/ClassMethods.html"><code>accepts_nested_attributes_for</code></a> method and how that passes params? Or how about an array of hashes, where some hashes might include extra keys.</p>

<p>If we run those cases against out code now, we’ll get incorrect results:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11</pre></td><td class="code"><pre><span class="c1"># HOW accepts_nested_attributes_for SOMETIMES PASSES IN PARAMS:</span>
<span class="n">recursive_suggested_strong_parameters_format</span> <span class="ss">products: </span><span class="p">[{</span><span class="s2">"1"</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">name: </span><span class="s2">"Product 1"</span> <span class="p">},</span> <span class="s2">"2"</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">name: </span><span class="s2">"Product 2"</span><span class="p">}}]</span>
<span class="c1"># [{:products_attributes=&gt;[{:"1"=&gt;[:name]}, {:"2"=&gt;[:name]}]}]</span>
<span class="c1"># WRONG ANSWER, SHOULD BE:</span>
<span class="c1"># [{:products=&gt;[:name]}]</span>

<span class="c1"># HASHES CONTAIN DIFFERENT KEYS:</span>
<span class="n">recursive_suggested_strong_parameters_format</span> <span class="ss">products: </span><span class="p">[{</span><span class="ss">name: </span><span class="s2">"Product 1"</span> <span class="p">},</span> <span class="p">{</span><span class="ss">name: </span><span class="s2">"Product 2"</span><span class="p">,</span> <span class="ss">description: </span><span class="s2">"Awesome"</span><span class="p">}]</span>
<span class="c1"># [{:products=&gt;[:name]}]</span>
<span class="c1"># WRONG ANSWER, SHOULD BE:</span>
<span class="c1"># [{:products=&gt;[:name, :description]}]</span>
</pre></td></tr></tbody></table>
</div>

<h3><code>accepts_nested_attributes_for</code> Method of Passing Params</h3>

<p>If you’re model accepts nested attributes for a has many relationship, then it passes parameters to your controller action slightly differently. The request parameters might look something more like this:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="ss">products_attributes: </span><span class="p">[{</span><span class="s2">"1"</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">name: </span><span class="s2">"Product 1"</span> <span class="p">},</span> <span class="s2">"2"</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">name: </span><span class="s2">"Product 2"</span><span class="p">}}]</span>
</pre></td></tr></tbody></table>
</div>

<p>In computing our strong parameters format, we want to completely ignore the IDs “1” and “2” here. To do so, we should examine the first key in a hash and see if it’s an integer. If it is, we should only use the value of the hash and not the key. Our updated code would now look like this:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">recursive_suggested_strong_parameters_format</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">object</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">object</span><span class="p">.</span><span class="nf">keys</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/^\d+$/</span><span class="p">)</span>
      <span class="n">recursive_suggested_strong_parameters_format</span><span class="p">(</span><span class="n">object</span><span class="p">.</span><span class="nf">values</span><span class="p">.</span><span class="nf">first</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">permitted_params</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">object</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span> <span class="o">||</span> <span class="n">value</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Array</span><span class="p">)</span>
          <span class="n">permitted_params</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="ss">:"</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="ss">"</span> <span class="o">=&gt;</span> <span class="n">recursive_suggested_strong_parameters_format</span><span class="p">(</span><span class="n">value</span><span class="p">)}</span>
        <span class="k">else</span>
          <span class="n">permitted_params</span> <span class="o">&lt;&lt;</span> <span class="ss">:"</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="ss">"</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="n">permitted_params</span>
    <span class="k">end</span>
  <span class="k">elsif</span> <span class="n">object</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Array</span><span class="p">)</span>
    <span class="c1"># it is sufficient to look at the first element of the array to determine if this is an array of hashes of just a array of scalars</span>
    <span class="k">if</span> <span class="n">object</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span>
      <span class="n">recursive_suggested_strong_parameters_format</span><span class="p">(</span><span class="n">object</span><span class="p">.</span><span class="nf">first</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="p">[]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">recursive_suggested_strong_parameters_format</span> <span class="ss">products: </span><span class="p">[{</span><span class="s2">"1"</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">name: </span><span class="s2">"Product 1"</span> <span class="p">},</span> <span class="s2">"2"</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">name: </span><span class="s2">"Product 2"</span><span class="p">}}]</span> <span class="c1"># =&gt; [{:products=&gt;[:name]}]</span>
</pre></td></tr></tbody></table>
</div>

<h3>Merging Hashes</h3>

<p>Almost there. We have one final case to handle. How should we handle an array of hashes where the keys in the hash might differ? For example, suppose our request params look like this:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="p">{</span> <span class="ss">products: </span><span class="p">[{</span><span class="ss">name: </span><span class="s2">"Product 1"</span><span class="p">,</span> <span class="ss">summary: </span><span class="s2">"My summary"</span> <span class="p">},</span> <span class="p">{</span><span class="ss">name: </span><span class="s2">"Product 2"</span><span class="p">,</span> <span class="ss">description: </span><span class="s2">"Awesome"</span><span class="p">}]</span> <span class="p">}</span>
</pre></td></tr></tbody></table>
</div>

<p>What we need is for the array of hashes above to essentially be combined into a single hash that includes all the keys:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="p">{</span> <span class="ss">name: </span><span class="s2">"Product 2"</span><span class="p">,</span> <span class="ss">summary: </span><span class="s2">"My summary"</span><span class="p">,</span> <span class="ss">description: </span><span class="s2">"Awesome"</span> <span class="p">}</span>
</pre></td></tr></tbody></table>
</div>

<p>With this combined hash, we already have the code necessary to handle it. So how do we combine hashes? At first thought, you might be tempted to say <a href="http://ruby-doc.org/core-2.2.0/Hash.html#method-i-merge"><code>Hash#merge</code></a>. And this would certainly handle the above case. But it would not handle the following case:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="p">[{</span><span class="ss">name: </span><span class="s2">"Product 1"</span><span class="p">,</span> <span class="ss">details: </span><span class="p">{</span> <span class="ss">description: </span><span class="s2">"Awesome"</span> <span class="p">}</span> <span class="p">},</span> <span class="p">{</span><span class="ss">name: </span><span class="s2">"Product 2"</span><span class="p">,</span> <span class="ss">details: </span><span class="p">{</span> <span class="ss">summary: </span><span class="s2">"My summary"</span> <span class="p">}}]</span>
</pre></td></tr></tbody></table>
</div>

<p>We have deep nestings here, so we need to use <a href="http://apidock.com/rails/Hash/deep_merge"><code>Hash#deep_merge</code></a> (a Hash extension provided by Rails. If we deep_merge the two hashes above, we would get:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="p">{</span><span class="ss">name: </span><span class="s2">"Product 2"</span><span class="p">,</span> <span class="ss">details: </span><span class="p">{</span> <span class="ss">description: </span><span class="s2">"Awesome"</span><span class="p">,</span> <span class="ss">summary: </span><span class="s2">"My summary"</span> <span class="p">}}</span>
</pre></td></tr></tbody></table>
</div>

<p>We also have to account for request parameters in the format:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="ss">products_attributes: </span><span class="p">[{</span><span class="s2">"1"</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">name: </span><span class="s2">"Product 1"</span> <span class="p">},</span> <span class="s2">"2"</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">name: </span><span class="s2">"Product 2"</span><span class="p">}}]</span>
</pre></td></tr></tbody></table>
</div>

<p>We can handle both of these cases with a few minor tweaks to our function:</p>
<div class="highlight ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></td><td class="code"><pre>  <span class="k">def</span> <span class="nf">recursive_suggested_strong_parameters_format</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">object</span><span class="p">.</span><span class="nf">is_a?</span> <span class="no">Hash</span>
      <span class="k">if</span> <span class="n">object</span><span class="p">.</span><span class="nf">keys</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/^\d+$/</span><span class="p">)</span>
        <span class="nb">hash</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">object</span><span class="p">.</span><span class="nf">values</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
          <span class="nb">hash</span><span class="p">.</span><span class="nf">deep_merge!</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">end</span>
        <span class="n">recursive_suggested_strong_parameters_format</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="n">permitted_params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">object</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
          <span class="k">if</span> <span class="n">value</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span> <span class="o">||</span> <span class="n">value</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Array</span><span class="p">)</span>
            <span class="n">permitted_params</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="ss">:"</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="ss">"</span> <span class="o">=&gt;</span> <span class="n">recursive_suggested_strong_parameters_format</span><span class="p">(</span><span class="n">value</span><span class="p">)}</span>
          <span class="k">else</span>
            <span class="n">permitted_params</span> <span class="o">&lt;&lt;</span> <span class="ss">:"</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="ss">"</span>
          <span class="k">end</span>
        <span class="k">end</span>
        <span class="n">permitted_params</span>
      <span class="k">end</span>
    <span class="k">elsif</span> <span class="n">object</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Array</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">object</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span>
        <span class="nb">hash</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">object</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span>
          <span class="nb">hash</span><span class="p">.</span><span class="nf">deep_merge!</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">end</span>
        <span class="n">recursive_suggested_strong_parameters_format</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="p">[]</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
</pre></td></tr></tbody></table>
</div>

<h3>Conclusion</h3>

<p>There’s really not much else to include other than the fact that recursion can be pretty awesome and can be used to solve a wide-variety of problems fairly succinctly. Obviously, there are refactorings that can be done to the code but I’ll leave that for another day. If there is enough interest in this article, I’ll write another one about how to use recursion to write your own ActiveRecord extension to generate the SQL insert statement for any record or set of records.</p>

        <div id="disqus_thread"></div>
<script type="text/javascript">
//<![CDATA[
                  var disqus_shortname = 'codeandtheology';
          
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        <script type="text/javascript">
//<![CDATA[
    var disqus_shortname = 'codeandtheology';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
//]]>
</script>

    </div>

    <!-- Footer -->
    <footer id="footer">
      <div class="in">
        <section class="copyright-area">
        </section>
      </div>

      <section class="copyright">
        <div class="in">
          <p class="copyright-message">
            <span class="site-copyright">
              Copyright © 2015 <a href="/">Code &amp; Theology (&amp; Life)</a>. All Rights Reserved.</span>
              <span class="slocum-credit">
                <a href="http://slocumthemes.com/wordpress-themes/capture-free/" target="_blank">Capture by Slocum Studio</a>
            </span>
          </p>
        </div>
      </section>
    </footer>
  </body>
</html>
